<!doctype html>
<html lang="en">
    <head>

        <style>
            #app-loader {
            position: fixed; inset: 0; z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            background: #fff;            /* 深色主題改成 #111 */
            transition: opacity .3s ease;
          }
          #app-loader.hidden { opacity: 0; pointer-events: none; }
          .spinner {
            width: 48px; height: 48px;
            border: 4px solid #e5e7eb;
            border-top-color: #3085d6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
          }
          @keyframes spin { to { transform: rotate(360deg); } }
          html.loading, body.loading { overflow: hidden; }
          .card-default { box-shadow: 0 2px 5px #cecece; }
          .card-active  { box-shadow: 0 0 0 3px #1a8755, 0 6px 14px rgba(0,0,0,.12) !important; }
        </style>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <!-- Bootstrap CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
        <!-- swal -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

        <title>土司三明治</title>

    <body>

        {% block nav %}
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
          <div class="container-fluid">
            <a style="color: #1a8755 ; font-weight: 900" class="navbar-brand" href="/">土司三明治</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" >

                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                      <a class="nav-link active" aria-current="page" href="/table/">歷史紀錄</a>
                    </li>

                    <li class="nav-item" style="margin-left: 25px">
                      <div class="col d-flex justify-content-center">
                        <nav aria-label="Page navigation example">
                          <ul class="pagination mb-0">

                            <li class="page-item">
                              <a style="color: #1a8755" class="page-link">{{ annotations }}~{{ annotations|add:t}}</a>
                            </li>

                          </ul>
                        </nav>
                      </div>
                    </li>

                </ul>
                <form class="d-flex">
                    <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
                    <button class="btn btn-outline-success" type="submit">Search</button>
                </form>
              </div>

            </div>


        </nav>
        {% endblock %}

        {% block content %}
        <div style="margin: 50px">
            <div class="row row-cols-5 g-3">
            {% for i,task in tasks %}
                <div class="col d-flex">
                    <div id="card_{{ i }}" class="card h-100 w-100 card-default" style="border:0; ">
                        <img src="{{ task.data.image_url }}" class="card-img-top" alt="...">
                        <div class="card-body d-flex flex-column">
                            <h6 class="card-title">{{ i }}/30000</h6>

                            <div class="d-flex justify-content-between align-items-center" style="margin-top: 15px;margin-bottom: 15px">
                                <h4 class="card-title mb-0">{{ task.data.query }}</h4>

                                <a href="https://www.google.com/search?q={{ task.data.query }}"
                                   target="_blank"
                                   rel="noopener noreferrer"
                                   style="text-decoration: none; color: #979797; background: #f1f1f1; padding: 2px 8px; border-radius: 15px; font-size: 12px;">
                                  google 搜尋
                                </a>
                            </div>
                            <p class="card-text flex-grow-1">{{ task.data.IT_NAME }}</p>
                            <span id="type_{{ i }}">_</span>
                        </div>
                    </div>
                </div>
            {% endfor %}
            </div>
        </div>

        {% endblock %}

        <!-- Optional JavaScript; choose one of the two! -->

        <!-- Option 1: Bootstrap Bundle with Popper -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

        <!-- Option 2: Separate Popper and Bootstrap JS -->
        <!--
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
        -->
    </body>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    <script>


        // ========================== loading  ==========================

        if ('scrollRestoration' in history) {
          history.scrollRestoration = 'manual';
        }
        // 即使使用 bfcache 快取回來，也強制回頂
        window.addEventListener('pageshow', () => {
          window.scrollTo(0, 0);
        });



        function ensureLoader() {
          let el = document.getElementById('app-loader');
          if (!el) {
            el = document.createElement('div');
            el.id = 'app-loader';
            el.innerHTML = '<div class="spinner"></div>';
            // 需要你的 CSS 已定義 #app-loader、.spinner
            document.body.appendChild(el);
          }
          return el;
        }
        function showLoader() {
          const el = ensureLoader();
          el.classList.remove('hidden');
          document.documentElement.classList.add('loading'); // 若你在 CSS 有禁止捲動
          document.body.classList.add('loading');
        }
        function hideLoader() {
          const el = document.getElementById('app-loader');
          if (!el) return;
          el.classList.add('hidden'); // 有 transition 的話會淡出
          setTimeout(() => {
            // 如果你想保留節點，下行可拿掉
            // el.remove();
            document.documentElement.classList.remove('loading');
            document.body.classList.remove('loading');
          }, 300); // 對齊你的 CSS transition 時間
        }

        //==========================  IT_NAME & query  ==========================
        (function () {

              // 所有卡片：你是用 i 當 index，所以找所有可能的 card-body
              const cards = document.querySelectorAll('.card .card-body');
              cards.forEach((card) => {
                const titleEl = card.querySelector('h4.card-title');         // 放 query
                const textEl  = card.querySelector('p.card-text');           // 放 IT_NAME
                if (!titleEl || !textEl) return;

                const query = (titleEl.textContent || '').trim();
                const itName = textEl.textContent || '';

                if (!query) return;

                // 不分大小寫找位置
                const idx = itName.toLowerCase().indexOf(query.toLowerCase());
                if (idx === -1) return;  // 沒找到就跳過

                const before = itName.slice(0, idx);
                const match  = itName.slice(idx, idx + query.length);
                const after  = itName.slice(idx + query.length);

                // 用 mark 包住
                textEl.innerHTML =
                  before +
                  '<mark style="background: #fff59d; padding: 0 2px;">' +
                  match +
                  '</mark>' +
                  after;
              });
            })();

        
        // ========================== 所有快捷設定 ==========================
        let id_ = Number({{ annotations }});
        let total = Number({{ total }});
        let current_id = id_;

        (function () {
          showLoader();

          const BASE = id_;
          const MAX  = BASE + total - 1;
          let $type  = document.getElementById(`type_${current_id}`);

          let currentNum = null; // 0~4
          let currentAux = null; // i/e/s/c
          let lastCombo  = null;

          const lastAuxByNum = {
              '0':'i','1':'i','2':'c','3':'e','4':'e'
          };
          const lastAuxByType = {
              'i':'0','c':'2','s':'2','e':'4',
          };

          function highlightCard(id, { scroll = false } = {}) {
            const el = document.getElementById(`card_${id}`);
            if (!el) return;
            document.querySelectorAll('.card-active').forEach(x => x.classList.remove('card-active'));
            el.classList.remove('card-default');
            el.classList.add('card-active');
            if (scroll) el.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
          }
          function dimCard(id) {
            const el = document.getElementById(`card_${id}`);
            if (!el) return;
            el.classList.remove('card-active');
            el.classList.add('card-default');
          }
          highlightCard(current_id, { scroll: false });

          const clampId = (v) => Math.max(BASE, Math.min(MAX, v));

          function applySelectionChange(prevId) {
            if (prevId !== current_id) {
              dimCard(prevId);
              highlightCard(current_id, { scroll: true });
              $type = document.getElementById(`type_${current_id}`);
            }
          }

          function mapKey(ev) {
              const c = ev.code;

              if (ev.ctrlKey || ev.metaKey) return null;

              // 類型組（用 code，避免被輸入法影響）
              if (c === 'Tab')         return { type: 'aux', value: 'i', prevent: true };
              if (c === 'KeyE')        return { type: 'aux', value: 'e' };
              if (c === 'KeyS')        return { type: 'aux', value: 's' };
              if (c === 'KeyC')        return { type: 'aux', value: 'c' };

              // 數字組（同樣用 code）
              if (c === 'Backquote')   return { type: 'num', value: '0' };
              if (c === 'Digit1' || c === 'Numpad1') return { type: 'num', value: '1' };
              if (c === 'Digit2' || c === 'Numpad2') return { type: 'num', value: '2' };
              if (c === 'Digit3' || c === 'Numpad3') return { type: 'num', value: '3' };
              if (c === 'Digit4' || c === 'Numpad4') return { type: 'num', value: '4' };

              return null;
            }    

          function updateDisplay() {
              if (!$type) return;
              // 只在 null/undefined 時才用 '_'，不會把 0 誤當空
              const left  = currentNum  != null ? String(currentNum)  : '_';
              const right = currentAux  ?? '_';
              const combo = left + right;
              $type.textContent = combo;
              if (combo !== lastCombo) lastCombo = combo;
          }
          
          function getCurrent(){
              $type = document.getElementById(`type_${current_id}`);
              if (!$type) return;
              return $type.innerText
          }
          
          function resetCurrent(){
              currentAux = null;
              currentNum = null
              if (getCurrent() !== '_'){
                  let temp = getCurrent()
                  currentAux = temp[1]
                  currentNum = temp[0]
              }
          }

          window.addEventListener('keydown', (ev) => {
              // 先把鍵盤映射出來（用 code 抓到熱鍵）
              const res = mapKey(ev);
              if (!res) {
                // 不是我們的熱鍵：這時候才可以因為組字而忽略
                if (ev.isComposing || ev.keyCode === 229) return;
                return;
              }

              // 我們的熱鍵：就算 isComposing 也要吃掉
              if (res.prevent) ev.preventDefault();

              if (res.type === 'num') {
                const num = String(res.value);
                if (currentAux == null) currentAux = lastAuxByNum[num]; // 用預設英文
                currentNum = num;                                       // 覆蓋數字
                $type = document.getElementById(`type_${current_id}`);
                updateDisplay();
                return;
              }

              if (res.type === 'aux') {
                const aux = res.value;
                if (currentNum == null) currentNum = lastAuxByType[aux]; // 用預設數字
                currentAux = aux;                                        // 覆蓋英文
                $type = document.getElementById(`type_${current_id}`);
                updateDisplay();
                return;
              }
            });


          window.addEventListener('keydown', (ev) => {
              if (ev.isComposing || ev.keyCode === 229) return;
    
              const prev = current_id;
    
              // Ctrl+`：下一張
              if ((ev.ctrlKey) && (ev.key === '`' || ev.code === 'Backquote')) {
                current_id = clampId(current_id + 1);
                applySelectionChange(prev);
                ev.preventDefault();          // ← 阻止預設行為
                  
                resetCurrent()
                  
                  
                return;
              }
    
              // === 方向鍵導覽 ===
              const GRID_COLS = 5;            // 你的版面一列 5 張卡，之後改版只要改這裡
              let handledNav = false;
    
              switch (ev.key) {
                case 'ArrowUp':
                  current_id = clampId(current_id - GRID_COLS);
                  handledNav = true;
                  resetCurrent()
                  break;
                case 'ArrowDown':
                  current_id = clampId(current_id + GRID_COLS);
                  handledNav = true;
                  resetCurrent()
                  break;
                case 'ArrowLeft':
                  current_id = clampId(current_id - 1);
                  handledNav = true;
                  resetCurrent()
                  break;
                case 'ArrowRight':
                  current_id = clampId(current_id + 1);
                  handledNav = true;
                  resetCurrent()
                  break;
                default:
                  return; // 非導航鍵
              }
    
              // 阻止瀏覽器用上下鍵捲動整頁
              ev.preventDefault();
    
              if (prev !== current_id) {
                // 有換卡 → 高亮並置中
                applySelectionChange(prev);
              } else {
                // 沒換卡（例如已在第一列又按 ArrowUp）→ 也強制置中目前卡片
                highlightCard(current_id, { scroll: true });
              }
            });

          hideLoader();
        })();
            
        
        // ========================== request ==========================

        function getCookie(name){
          const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
          return m ? m.pop() : null;
        }

        function gatherBatch(baseId, count) {
          const out = [];
          let unlabeled = 0;
        
          for (let i = baseId; i < baseId + count; i++) {
            const el = document.getElementById(`type_${i}`);
            const comboText = el?.textContent?.trim() ?? '';
        
            const first  = comboText[0] ?? '';
            const second = comboText[1] ?? '';
        
            const num = '01234'.includes(first) ? first : null;
            const aux = 'iesc'.includes(second) ? second : null;
        
            if (num == null || aux == null) unlabeled += 1;
        
            out.push({
              index: i,
              num,                      // '0'~'4' 或 null
              aux,                      // 'i'|'e'|'s'|'c' 或 null
              combo: `${num ?? '_'}${aux ?? '_'}` // 只有顯示用才補底線
            });
          }
        
          console.log(out.length);
          return { out, unlabeled }; // 用物件回傳多值
        }

    
            
        async function postBatchLabels(batch) {
          const headers = { 'Content-Type': 'application/json' };
          const csrftoken = getCookie('csrftoken');
          if (csrftoken) headers['X-CSRFToken'] = csrftoken;   // Django 需要
        
          const res = await fetch('/', {
            method: 'POST',
            headers,
            body: JSON.stringify({ batch }),   // 後端就收 { "batch": [...] }
            credentials: 'same-origin'
          });
        
          if (!res.ok) {
            const text = await res.text().catch(()=>'');
            throw new Error(`POST / 失敗：${res.status} ${text}`);
          }
          try { return await res.json(); } catch { return {}; }
        }    

        window.addEventListener('keydown', async (e) => {
          // 避免在輸入框裡誤觸
          const t = e.target, tag = (t.tagName || '').toLowerCase();
          const isTyping = tag === 'input' || tag === 'textarea' || t.isContentEditable;
          if (isTyping) return;
        
          if (e.key === 'Enter') {
            e.preventDefault();
            e.stopPropagation();
        
            // 先蒐集本批資料
            const { out: batch, unlabeled } = gatherBatch(id_, total);
        
            // 若有未標註，先問使用者是否送出
            if (unlabeled > 0) {
              const res = await Swal.fire({
                icon: 'warning',
                title: '仍有未標註項目',
                html: `共有 <b>${unlabeled}</b> 筆未標註，確定要送出嗎？`,
                showCancelButton: true,
                confirmButtonText: '送出',
                cancelButtonText: '先檢查'
              });
              if (!res.isConfirmed) return; // 使用者取消 → 不做事
            }
        
            // 顯示「寫入中…」並送出
            Swal.fire({
              title: '寫入中…',
              html: '請稍候',
              allowOutsideClick: false,
              allowEscapeKey: false,
              didOpen: () => Swal.showLoading()
            });
        
            try {
              const r = await postBatchLabels(batch);
        
              Swal.close();
        
              // 維持你原本的成功判斷
              if (r && r.errno === true) {
                if (typeof showLoader === 'function') showLoader();
                window.scrollTo({ top: 0 });
                location.reload(); // 或 location.href = `?start=${id_+10}`;
              } else {
                Swal.fire({ icon: 'error', title: '系統錯誤', text: '請聯絡管理員' });
              }
            } catch (err) {
              Swal.close();
              Swal.fire({ icon: 'error', title: '網路錯誤', text: err?.message || '請稍後再試' });
            }
          }
        })

    </script>

</html>